<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Helpdesk Kanban</title>

    <!-- React 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for in-browser JSX transform (dev only) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      html, body, #root { height: 100%; margin: 0; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; color: #111827; background: #f8fafc; }
      .app { display: flex; flex-direction: column; min-height: 100%; }
      .header { padding: 12px 16px; font-weight: 600; }
      .board { display: flex; gap: 12px; padding: 12px; overflow-x: auto; align-items: flex-start; }
      .column { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; width: 280px; flex: 0 0 280px; display: flex; flex-direction: column; max-height: calc(100vh - 80px); }
      .column-header { padding: 10px 12px; font-weight: 600; border-bottom: 1px solid #e5e7eb; }
      .task-list { padding: 8px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; min-height: 40px; }
      .task { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px 10px; cursor: grab; }
      .task:active { cursor: grabbing; }
      .new-task { padding: 8px; border-top: 1px solid #e5e7eb; display: grid; gap: 6px; }
      .new-task input { padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 6px; }
      .new-task button { padding: 8px 10px; border: 1px solid #d1d5db; background: #111827; color: #fff; border-radius: 6px; cursor: pointer; }
      .new-task button:disabled { opacity: .6; cursor: not-allowed; }
      .footer { margin-top: auto; padding: 8px 12px; color: #6b7280; font-size: 12px; }
      .drop-hover { outline: 2px dashed #60a5fa; outline-offset: -4px; background: #eff6ff; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      const DEFAULT_COLUMNS = [
        { id: 'new', title: 'Новые' },
        { id: 'inprogress', title: 'В работе' },
        { id: 'waiting', title: 'Ожидание' },
        { id: 'done', title: 'Готово' },
      ];

      function loadBoard() {
        try {
          const raw = localStorage.getItem('kanban-board-v1');
          if (!raw) return null;
          return JSON.parse(raw);
        } catch {
          return null;
        }
      }

      function saveBoard(state) {
        try {
          localStorage.setItem('kanban-board-v1', JSON.stringify(state));
        } catch {}
      }

      function createTaskId() {
        return 't_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
      }

      function App() {
        const [columns] = useState(DEFAULT_COLUMNS);
        const [tasksByColumn, setTasksByColumn] = useState(() => {
          const saved = loadBoard();
          if (saved && saved.tasksByColumn) return saved.tasksByColumn;
          return {
            new: [],
            inprogress: [],
            waiting: [],
            done: [],
          };
        });
        const [newTaskTitle, setNewTaskTitle] = useState('');

        useEffect(() => {
          saveBoard({ tasksByColumn });
        }, [tasksByColumn]);

        function handleAddTask(e) {
          e.preventDefault();
          const title = newTaskTitle.trim();
          if (!title) return;
          const task = { id: createTaskId(), title };
          setTasksByColumn(prev => ({
            ...prev,
            new: [task, ...prev.new],
          }));
          setNewTaskTitle('');
        }

        function handleDragStart(task, fromColumnId) {
          return (e) => {
            e.dataTransfer.setData('text/task-id', task.id);
            e.dataTransfer.setData('text/from-column', fromColumnId);
            e.dataTransfer.effectAllowed = 'move';
          };
        }

        function handleDragOver(columnId) {
          return (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drop-hover');
          };
        }

        function handleDragLeave(e) {
          e.currentTarget.classList.remove('drop-hover');
        }

        function handleDrop(columnId) {
          return (e) => {
            e.preventDefault();
            e.currentTarget.classList.remove('drop-hover');
            const taskId = e.dataTransfer.getData('text/task-id');
            const fromColumnId = e.dataTransfer.getData('text/from-column');
            if (!taskId || !fromColumnId || fromColumnId === columnId) return;
            setTasksByColumn(prev => {
              const fromList = prev[fromColumnId] || [];
              const taskIndex = fromList.findIndex(t => t.id === taskId);
              if (taskIndex === -1) return prev;
              const task = fromList[taskIndex];
              const newFrom = [...fromList.slice(0, taskIndex), ...fromList.slice(taskIndex + 1)];
              const toList = prev[columnId] || [];
              const newTo = [task, ...toList];
              return { ...prev, [fromColumnId]: newFrom, [columnId]: newTo };
            });
          };
        }

        return (
          <div className="app">
            <div className="header">Helpdesk · Канбан</div>
            <div className="board">
              {columns.map(col => (
                <div key={col.id} className="column">
                  <div className="column-header">{col.title}</div>
                  <div
                    className="task-list"
                    onDragOver={handleDragOver(col.id)}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop(col.id)}
                  >
                    {(tasksByColumn[col.id] || []).map(task => (
                      <div
                        key={task.id}
                        className="task"
                        draggable
                        onDragStart={handleDragStart(task, col.id)}
                        title={task.title}
                      >
                        {task.title}
                      </div>
                    ))}
                  </div>
                  {col.id === 'new' && (
                    <form className="new-task" onSubmit={handleAddTask}>
                      <input
                        type="text"
                        value={newTaskTitle}
                        onChange={(e) => setNewTaskTitle(e.target.value)}
                        placeholder="Краткое описание задачи"
                      />
                      <button type="submit" disabled={!newTaskTitle.trim()}>Добавить</button>
                    </form>
                  )}
                </div>
              ))}
            </div>
            <div className="footer">Перетащите задачи между колонками. Данные сохраняются в браузере.</div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
  </html>

