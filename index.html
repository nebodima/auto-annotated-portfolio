<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Helpdesk Kanban</title>

    <!-- React 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for in-browser JSX transform (dev only) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      html, body, #root { height: 100%; margin: 0; }
      body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; color: #0f172a; background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%); }
      * { box-sizing: border-box; }

      .app { display: flex; flex-direction: column; min-height: 100%; }
      .header { position: sticky; top: 0; z-index: 10; backdrop-filter: saturate(180%) blur(6px); background: rgba(248, 250, 252, 0.8); border-bottom: 1px solid #e5e7eb; padding: 14px 16px; display: flex; align-items: center; gap: 10px; }
      .header .title { font-weight: 700; letter-spacing: 0.2px; }

      .board { display: flex; gap: 16px; padding: 16px; overflow-x: auto; align-items: flex-start; }
      .column { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; width: 320px; flex: 0 0 320px; display: flex; flex-direction: column; max-height: calc(100vh - 120px); box-shadow: 0 6px 16px rgba(2, 6, 23, 0.06); }
      .column-header { padding: 12px 14px; font-weight: 700; border-bottom: 1px solid #eef2f7; display: flex; align-items: center; justify-content: space-between; }
      .count { background: #f1f5f9; color: #334155; border: 1px solid #e2e8f0; border-radius: 999px; padding: 2px 8px; font-size: 12px; font-weight: 600; }
      .task-list { padding: 12px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; min-height: 60px; }
      .task { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; cursor: grab; box-shadow: 0 1px 0 rgba(2, 6, 23, 0.04); transition: box-shadow .15s ease, transform .05s ease; }
      .task:hover { box-shadow: 0 6px 16px rgba(2, 6, 23, 0.08); }
      .task:active { cursor: grabbing; }
      .task-title { font-weight: 600; margin: 0 0 6px; font-size: 14px; color: #0f172a; }
      .task-desc { margin: 0; color: #475569; font-size: 12px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
      .task-meta { display: flex; align-items: center; justify-content: space-between; margin-top: 8px; }
      .chip { border-radius: 999px; padding: 2px 8px; font-size: 12px; font-weight: 600; border: 1px solid; }
      .chip.low { color: #1d4ed8; background: #eff6ff; border-color: #bfdbfe; }
      .chip.medium { color: #92400e; background: #fffbeb; border-color: #fde68a; }
      .chip.high { color: #991b1b; background: #fef2f2; border-color: #fecaca; }
      .edit-hint { color: #94a3b8; font-size: 12px; }

      .new-task { padding: 12px; border-top: 1px solid #eef2f7; display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
      .new-task input, .modal input, .modal textarea, .modal select { padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 14px; }
      .new-task select { padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 14px; }
      .new-task .add-row { display: contents; }
      .new-task button { padding: 10px 12px; border: 1px solid #0f172a; background: #0f172a; color: #fff; border-radius: 10px; cursor: pointer; font-weight: 600; }
      .new-task button:disabled { opacity: .6; cursor: not-allowed; }

      .footer { margin-top: auto; padding: 10px 16px; color: #6b7280; font-size: 12px; }
      .drop-hover { outline: 2px dashed #60a5fa; outline-offset: -4px; background: #f0f9ff; }

      /* Modal */
      .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.45); display: flex; align-items: center; justify-content: center; z-index: 50; }
      .modal { width: 520px; max-width: calc(100% - 24px); background: #ffffff; border: 1px solid #e5e7eb; border-radius: 14px; box-shadow: 0 24px 48px rgba(2, 6, 23, 0.2); padding: 16px; display: grid; gap: 10px; }
      .modal h3 { margin: 0 0 4px; }
      .modal .row { display: grid; gap: 6px; }
      .modal-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
      .modal .btn { padding: 10px 12px; border-radius: 10px; cursor: pointer; font-weight: 700; border: 1px solid transparent; }
      .btn.primary { background: #0f172a; color: #fff; }
      .btn.ghost { background: #ffffff; color: #0f172a; border-color: #e5e7eb; }
      .btn.danger { background: #991b1b; color: #fff; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;

      const DEFAULT_COLUMNS = [
        { id: 'new', title: 'Новые' },
        { id: 'inprogress', title: 'В работе' },
        { id: 'waiting', title: 'Ожидание' },
        { id: 'done', title: 'Готово' },
      ];

      function loadBoard() {
        try {
          const raw = localStorage.getItem('kanban-board-v1');
          if (!raw) return null;
          return JSON.parse(raw);
        } catch {
          return null;
        }
      }

      function saveBoard(state) {
        try {
          localStorage.setItem('kanban-board-v1', JSON.stringify(state));
        } catch {}
      }

      function createTaskId() {
        return 't_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
      }

      function migrateTasks(oldState) {
        // Ensure tasks have description and priority; default priority medium
        const byCol = oldState?.tasksByColumn || oldState || {};
        const normalizeList = (lst) => (lst || []).map(t => ({
          id: t.id || createTaskId(),
          title: t.title || 'Без названия',
          description: t.description || '',
          priority: t.priority || 'medium',
        }));
        return {
          new: normalizeList(byCol.new),
          inprogress: normalizeList(byCol.inprogress),
          waiting: normalizeList(byCol.waiting),
          done: normalizeList(byCol.done),
        };
      }

      function App() {
        const [columns] = useState(DEFAULT_COLUMNS);
        const [tasksByColumn, setTasksByColumn] = useState(() => {
          const saved = loadBoard();
          if (saved) return migrateTasks(saved);
          return migrateTasks({ tasksByColumn: {} });
        });
        const [newTaskTitle, setNewTaskTitle] = useState('');
        const [newTaskPriority, setNewTaskPriority] = useState('medium');
        const [editingTask, setEditingTask] = useState(null); // {task, columnId}

        useEffect(() => {
          saveBoard({ tasksByColumn });
        }, [tasksByColumn]);

        function handleAddTask(e) {
          e.preventDefault();
          const title = newTaskTitle.trim();
          if (!title) return;
          const task = { id: createTaskId(), title, description: '', priority: newTaskPriority };
          setTasksByColumn(prev => ({
            ...prev,
            new: [task, ...prev.new],
          }));
          setNewTaskTitle('');
          setNewTaskPriority('medium');
        }

        function handleDragStart(task, fromColumnId) {
          return (e) => {
            e.dataTransfer.setData('text/task-id', task.id);
            e.dataTransfer.setData('text/from-column', fromColumnId);
            e.dataTransfer.effectAllowed = 'move';
          };
        }

        function handleDragOver(columnId) {
          return (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drop-hover');
          };
        }

        function handleDragLeave(e) {
          e.currentTarget.classList.remove('drop-hover');
        }

        function handleDrop(columnId) {
          return (e) => {
            e.preventDefault();
            e.currentTarget.classList.remove('drop-hover');
            const taskId = e.dataTransfer.getData('text/task-id');
            const fromColumnId = e.dataTransfer.getData('text/from-column');
            if (!taskId || !fromColumnId || fromColumnId === columnId) return;
            setTasksByColumn(prev => {
              const fromList = prev[fromColumnId] || [];
              const taskIndex = fromList.findIndex(t => t.id === taskId);
              if (taskIndex === -1) return prev;
              const task = fromList[taskIndex];
              const newFrom = [...fromList.slice(0, taskIndex), ...fromList.slice(taskIndex + 1)];
              const toList = prev[columnId] || [];
              const newTo = [task, ...toList];
              return { ...prev, [fromColumnId]: newFrom, [columnId]: newTo };
            });
          };
        }

        function openEdit(task, columnId) {
          setEditingTask({ task: { ...task }, columnId });
        }

        function closeEdit() { setEditingTask(null); }

        function saveEdit() {
          if (!editingTask) return;
          const { task, columnId } = editingTask;
          setTasksByColumn(prev => {
            const list = prev[columnId] || [];
            const idx = list.findIndex(t => t.id === task.id);
            if (idx === -1) return prev;
            const newList = [...list];
            newList[idx] = { ...task };
            return { ...prev, [columnId]: newList };
          });
          closeEdit();
        }

        function deleteTask(taskId, columnId) {
          setTasksByColumn(prev => {
            const list = prev[columnId] || [];
            return { ...prev, [columnId]: list.filter(t => t.id !== taskId) };
          });
          if (editingTask && editingTask.task.id === taskId) closeEdit();
        }

        const countsByColumn = useMemo(() => {
          return Object.fromEntries(columns.map(c => [c.id, (tasksByColumn[c.id] || []).length]));
        }, [columns, tasksByColumn]);

        return (
          <div className="app">
            <div className="header">
              <div className="title">Helpdesk · Канбан</div>
            </div>
            <div className="board">
              {columns.map(col => (
                <div key={col.id} className="column">
                  <div className="column-header">
                    <span>{col.title}</span>
                    <span className="count">{countsByColumn[col.id] || 0}</span>
                  </div>
                  <div
                    className="task-list"
                    onDragOver={handleDragOver(col.id)}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop(col.id)}
                  >
                    {(tasksByColumn[col.id] || []).map(task => (
                      <div
                        key={task.id}
                        className="task"
                        draggable
                        onDragStart={handleDragStart(task, col.id)}
                        title={task.title}
                        onDoubleClick={() => openEdit(task, col.id)}
                      >
                        <div className="task-title">{task.title}</div>
                        {task.description ? (<p className="task-desc">{task.description}</p>) : (<div className="edit-hint">Двойной клик для редактирования</div>)}
                        <div className="task-meta">
                          <span className={`chip ${task.priority}`}>{task.priority === 'high' ? 'Высокий' : task.priority === 'medium' ? 'Средний' : 'Низкий'}</span>
                          <button className="btn ghost" onClick={(e) => { e.stopPropagation(); openEdit(task, col.id); }}>Редактировать</button>
                        </div>
                      </div>
                    ))}
                  </div>
                  {col.id === 'new' && (
                    <form className="new-task" onSubmit={handleAddTask}>
                      <div className="add-row">
                        <input
                          type="text"
                          value={newTaskTitle}
                          onChange={(e) => setNewTaskTitle(e.target.value)}
                          placeholder="Краткое описание задачи"
                        />
                        <select value={newTaskPriority} onChange={(e) => setNewTaskPriority(e.target.value)}>
                          <option value="low">Низкий</option>
                          <option value="medium">Средний</option>
                          <option value="high">Высокий</option>
                        </select>
                        <button type="submit" disabled={!newTaskTitle.trim()}>Добавить</button>
                      </div>
                    </form>
                  )}
                </div>
              ))}
            </div>
            <div className="footer">Двойной клик по задаче — редактирование. Перетаскивайте между колонками. Сохраняется в браузере.</div>

            {editingTask && (
              <div className="modal-overlay" onClick={(e) => { if (e.target === e.currentTarget) closeEdit(); }}>
                <div className="modal" role="dialog" aria-modal="true">
                  <h3>Редактирование задачи</h3>
                  <div className="row">
                    <label>Заголовок</label>
                    <input
                      type="text"
                      value={editingTask.task.title}
                      onChange={(e) => setEditingTask(({ task, columnId }) => ({ task: { ...task, title: e.target.value }, columnId }))}
                    />
                  </div>
                  <div className="row">
                    <label>Описание</label>
                    <textarea rows="5"
                      value={editingTask.task.description}
                      onChange={(e) => setEditingTask(({ task, columnId }) => ({ task: { ...task, description: e.target.value }, columnId }))}
                    ></textarea>
                  </div>
                  <div className="row">
                    <label>Приоритет</label>
                    <select
                      value={editingTask.task.priority}
                      onChange={(e) => setEditingTask(({ task, columnId }) => ({ task: { ...task, priority: e.target.value }, columnId }))}
                    >
                      <option value="low">Низкий</option>
                      <option value="medium">Средний</option>
                      <option value="high">Высокий</option>
                    </select>
                  </div>
                  <div className="modal-actions">
                    <button className="btn danger" onClick={() => deleteTask(editingTask.task.id, editingTask.columnId)}>Удалить</button>
                    <div style={{ display: 'flex', gap: 8 }}>
                      <button className="btn ghost" onClick={closeEdit}>Отмена</button>
                      <button className="btn primary" onClick={saveEdit} disabled={!editingTask.task.title.trim()}>Сохранить</button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
  </html>

